#!/bin/bash
# activate - my-shell environment switcher
# Usage: activate [bash|zsh|fish]
#   If no argument, activates current shell's environment

# Determine project root directory (one level up from env/)
_ACTIVATE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
_ENV_DIR="$_ACTIVATE_DIR/env"
export MY_SHELL_ROOT="$_ACTIVATE_DIR"

# Determine shell type
_REQUESTED_SHELL="${1:-}"
_CURRENT_SHELL=""

# Detect current shell
# $SHELL often points to the login shell; we use PPID to infer the invoking shell when possible.
_PARENT_SHELL="$(basename "$SHELL" 2>/dev/null || echo '')"
_PARENT_COMM=""

if command -v ps >/dev/null 2>&1; then
    # macOS: `ps -p <pid> -o comm=` works; awk trims whitespace.
    _PARENT_COMM="$(ps -p "$PPID" -o comm= 2>/dev/null | awk '{print $1}')"
fi

case "$_PARENT_COMM" in
    fish|bash|zsh)
        _CURRENT_SHELL="$_PARENT_COMM"
        ;;
    *)
        # Fallbacks
        # NOTE: This file is a bash script, so $BASH_VERSION is always set here.
        # Do NOT use $BASH_VERSION to infer the user's interactive shell.
        if [ "$_PARENT_SHELL" = "fish" ] || [ "$_PARENT_SHELL" = "bash" ] || [ "$_PARENT_SHELL" = "zsh" ]; then
            _CURRENT_SHELL="$_PARENT_SHELL"
        elif [ -n "$ZSH_VERSION" ]; then
            _CURRENT_SHELL="zsh"
        elif [ -n "$FISH_VERSION" ]; then
            _CURRENT_SHELL="fish"
        elif [ -n "$_PARENT_SHELL" ]; then
            _CURRENT_SHELL="$_PARENT_SHELL"
        else
            _CURRENT_SHELL="bash"  # Default
        fi
        ;;
esac

# If shell not specified, use current shell
if [ -z "$_REQUESTED_SHELL" ]; then
    _REQUESTED_SHELL="$_CURRENT_SHELL"
fi

_REQUESTED_SHELL="$(echo "$_REQUESTED_SHELL" | tr '[:upper:]' '[:lower:]')"

# Validate shell
case "$_REQUESTED_SHELL" in
    bash|zsh|fish)
        ;;
    *)
        echo "Error: Unknown shell '$_REQUESTED_SHELL'. Supported: bash, zsh, fish" >&2
        exit 1
        ;;
esac

# If different shell requested, switch to it
if [ "$_REQUESTED_SHELL" != "$_CURRENT_SHELL" ]; then
    # Scenario D: Shell Switching (Switch Mode)
    export MY_SHELL_SWITCHED_FROM="$_CURRENT_SHELL"
    export MY_SHELL_ACTIVATION_MODE="switch"
    
    # Create temporary directory for switch artifacts
    _TMPDIR=$(mktemp -d)
    export MY_SHELL_TMPDIR="$_TMPDIR"
    
    case "$_REQUESTED_SHELL" in
        bash)
            echo "- Switching to bash and activating my-shell environment..."
            # Create temporary rcfile
            _TMP_RCFILE="$_TMPDIR/rcfile"
            cat > "$_TMP_RCFILE" <<EOF
export MY_SHELL_SWITCHED_FROM="$_CURRENT_SHELL"
export MY_SHELL_ACTIVATION_MODE="switch"
export MY_SHELL_ROOT="$MY_SHELL_ROOT"
export MY_SHELL_TMPDIR="$MY_SHELL_TMPDIR"
source "$MY_SHELL_ROOT/env/activate.bash"
EOF
            exec env -u MY_SHELL_ACTIVATED bash --rcfile "$_TMP_RCFILE" -i
            ;;
        zsh)
            echo "- Switching to zsh and activating my-shell environment..."
            # Create temporary zshrc
            mkdir -p "$_TMPDIR"
            cat > "$_TMPDIR/.zshrc" <<EOF
export MY_SHELL_SWITCHED_FROM="$_CURRENT_SHELL"
export MY_SHELL_ACTIVATION_MODE="switch"
export MY_SHELL_ROOT="$MY_SHELL_ROOT"
export MY_SHELL_TMPDIR="$MY_SHELL_TMPDIR"

# Keep zsh history in a stable location; ZDOTDIR is a temporary directory.
export HISTFILE="\$HOME/.zsh_history"
: >| "\$HISTFILE" 2>/dev/null || true

source "\$MY_SHELL_ROOT/env/activate.zsh"
EOF
            exec env -u MY_SHELL_ACTIVATED ZDOTDIR="$_TMPDIR" zsh -i
            ;;
        fish)
            echo "- Switching to fish and activating my-shell environment..."
            exec env -u MY_SHELL_ACTIVATED fish -c "set -gx MY_SHELL_SWITCHED_FROM '$_CURRENT_SHELL'; set -gx MY_SHELL_ACTIVATION_MODE 'switch'; set -gx MY_SHELL_ROOT '$MY_SHELL_ROOT'; set -gx MY_SHELL_TMPDIR '$MY_SHELL_TMPDIR'; set -gx MY_SHELL_FISH_SPAWNED 1; source '$MY_SHELL_ROOT/env/activate.fish'; exec fish -i"
            ;;
    esac
else
    # Same shell - activate in current shell
    # Check if already activated
    if [ -n "$MY_SHELL_ACTIVATED" ]; then
        echo "my-shell environment is already activated"
        exit 0
    fi
    
    case "$_CURRENT_SHELL" in
        bash)
            # Scenario B: Same shell activation (Bash)
            # NOTE: This switcher is executed (./env/activate), so sourcing activate.bash here would
            # only affect this script process, not the user's interactive bash. Therefore we re-exec
            # an interactive bash that sources activate.bash via a temporary rcfile.
            echo "- Switching to bash and activating my-shell environment..."
            _TMPDIR=$(mktemp -d)
            _TMP_RCFILE="$_TMPDIR/rcfile"
            cat > "$_TMP_RCFILE" <<EOF
export MY_SHELL_ROOT="$MY_SHELL_ROOT"
export MY_SHELL_ACTIVATION_MODE="source"
export MY_SHELL_SESSION_SPAWNED=1
export MY_SHELL_SPAWNED_SHELL="bash"
# Ensure we are not in switch-return mode
unset MY_SHELL_SWITCHED_FROM
# Source the bash activator (absolute path)
source "$MY_SHELL_ROOT/env/activate.bash"
# Cleanup temp artifacts created by the switcher itself
rm -rf "$_TMPDIR" 2>/dev/null || true
EOF
            exec env -u MY_SHELL_ACTIVATED bash --rcfile "$_TMP_RCFILE" -i
            ;;
        zsh)
            # Scenario B: Same shell activation (Zsh)
            # Same reasoning as Bash: we must exec an interactive zsh so activation affects the session.
            echo "- Switching to zsh and activating my-shell environment..."
            _TMPDIR=$(mktemp -d)
            cat > "$_TMPDIR/.zshrc" <<EOF
export MY_SHELL_ROOT="$MY_SHELL_ROOT"
export MY_SHELL_ACTIVATION_MODE="source"
unset MY_SHELL_SWITCHED_FROM

# Keep zsh history in a stable location; ZDOTDIR is a temporary directory.
export HISTFILE="\$HOME/.zsh_history"
: >| "\$HISTFILE" 2>/dev/null || true

source "\$MY_SHELL_ROOT/env/activate.zsh"
EOF
            exec env -u MY_SHELL_ACTIVATED ZDOTDIR="$_TMPDIR" zsh -i
            ;;
        fish)
            # Scenario C: Fish exec-activation
            echo "- Activating my-shell environment in fish..."
            export MY_SHELL_ACTIVATION_MODE="exec"
            export MY_SHELL_FISH_SPAWNED=1
            # Create temporary init file to ensure functions persist in new fish instance
            _TMP_INIT=$(mktemp)
            cat > "$_TMP_INIT" <<EOF
# Temporary init file for my-shell activation
set -gx MY_SHELL_ACTIVATION_MODE "exec"
set -gx MY_SHELL_FISH_SPAWNED 1
set -gx MY_SHELL_ROOT "$MY_SHELL_ROOT"
source '$MY_SHELL_ROOT/env/activate.fish'
EOF
            exec env -u MY_SHELL_ACTIVATED fish --init-command "source '$_TMP_INIT'; rm -f '$_TMP_INIT'" -i
            ;;
    esac
fi
