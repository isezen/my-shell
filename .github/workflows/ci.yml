name: CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  lint-and-test:
    name: Lint and Test
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up shell
        run: |
          echo "SHELL=$SHELL" >> $GITHUB_ENV
          echo "Running on ${{ matrix.os }}"

      - name: Install ShellCheck (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Install ShellCheck (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install shellcheck

      - name: Install Fish (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y fish

      - name: Install Fish (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install fish

      - name: Install BATS (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y bats

      - name: Install BATS (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install bats-core

      - name: Run ShellCheck
        run: make lint-bash

      - name: Run Fish syntax check
        run: make lint-fish

      - name: Run BATS tests
        run: make test-bats
        continue-on-error: false

      - name: Generate test coverage report
        if: always()
        run: |
          echo "## Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Run tests and capture output
          if command -v bats >/dev/null 2>&1; then
            TEST_OUTPUT=$(bats tests/*.bats 2>&1 || true)
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$TEST_OUTPUT" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Extract test counts
            TOTAL_TESTS=$(echo "$TEST_OUTPUT" | grep -E "^[0-9]+\.\.[0-9]+" | tail -1 | awk '{print $3}' || echo "0")
            PASSED_TESTS=$(echo "$TEST_OUTPUT" | grep -c "ok" || echo "0")
            FAILED_TESTS=$(echo "$TEST_OUTPUT" | grep -c "not ok" || echo "0")
            
            echo "### Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Total Tests | $TOTAL_TESTS |" >> $GITHUB_STEP_SUMMARY
            echo "| Passed | $PASSED_TESTS |" >> $GITHUB_STEP_SUMMARY
            echo "| Failed | $FAILED_TESTS |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Calculate coverage percentage
            if [ "$TOTAL_TESTS" -gt 0 ]; then
              COVERAGE=$(awk "BEGIN {printf \"%.1f\", ($PASSED_TESTS/$TOTAL_TESTS)*100}")
              echo "### Coverage: ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚ö†Ô∏è BATS not found. Cannot generate coverage report." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Tests |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          for test_file in tests/*.bats; do
            if [ -f "$test_file" ]; then
              TEST_COUNT=$(grep -c "^@test" "$test_file" || echo "0")
              echo "| \`$(basename "$test_file")\` | $TEST_COUNT |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìä For detailed coverage information, see [TEST_COVERAGE.md](../tests/TEST_COVERAGE.md)" >> $GITHUB_STEP_SUMMARY

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}
          path: |
            ${{ github.workspace }}/tests/TEST_COVERAGE.md
          retention-days: 30

      - name: Check test results
        if: failure()
        run: |
          echo "‚ùå Tests failed. Check the logs above for details."
          exit 1

